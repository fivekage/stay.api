steps:
  - id: "tf plan"
    name: "hashicorp/terraform:latest"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        echo "branch $BRANCH_NAME"
        if [ ! -z "$BRANCH_NAME" -a -d "terraform/environments/$BRANCH_NAME/"]; then
           cd terraform/environments/$BRANCH_NAME
           echo "run init"
           terraform init
           echo "run validate"
           terraform validate
           echo "run plan"
           terraform plan -out terraform.plan
           terraform apply -auto-approve terraform.plan
        else
           for dir in terraform/environments/*/
           do
              cd ${dir}
              env=${dir%*/}
              env=${env#*/}
              echo ""
              echo "********* TERRAFORM PLAN **********"
              echo "At environmnt: ${env}"
              echo "***********************************"
              terraform init
              terraform validate
              terraform plan || exit 1
              cd ../../
           done
        fi
logsBucket: "gs://mylogsbucket"
options:
  logging: CLOUD_LOGGING_ONLY
